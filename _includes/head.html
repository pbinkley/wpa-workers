<head>
  <meta http-equiv='Content-Type' content='text/html; charset=utf-8' />
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>
    {{ site.title }}{% if page.label %} | {{ page.label }}{% elsif page.title %} | {{ page.title }}{% endif %}
  </title>

  <meta property="og:title" content="{{ site.title }}{% if page.label %} | {{ page.label }}{% elsif page.title %} | {{ page.title }}{% endif %}" />
  <meta property="og:type" content="map" />
  <meta property="og:url" content="{{ page.url | absolute_url }}" />

  <link rel='canonical' href='{{ page.url | absolute_url }}'/>
  <link rel='icon' type='image/png' href="{{ 'img/logo.png' | absolute_url }}">
  <link rel='stylesheet' href="{{ '/assets/styles.css' | absolute_url }}"/>

  <script type='text/javascript' src="{{ '/assets/jquery-3.2.1.min.js' | absolute_url }}"></script>
  <noscript><p>Please enable JavaScript in your browser.</p></noscript>
  
  {% if page.map %}
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY=" crossorigin="" />
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js" integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo=" crossorigin=""></script>

    <script type="text/javascript">
        function initialize() {
            var layer = 'toner';
            var map = new L.Map('mapid', {
                center: new L.LatLng(37.8, -122.4),
                zoom: 10
            });
            L.tileLayer( 'https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a>',
                subdomains: ['a','b','c']
            }).addTo( map );


            var myStyle = {
            "color": "#ff7800",
            "weight": 5,
            "opacity": 0.65
            };

            var holcColor = {
            "A": "#008000",
            "B": "#0000FF",
            "C": "#FFFF00",
            "D": "#FF0000"
            }

            function newIcon(color) {
            return new L.Icon({
              iconUrl: '{{ site.baseurl }}/assets/img/marker-icon-' + color + '.png',
              shadowUrl: '{{ site.baseurl }}/assets/img/marker-shadow.png',
              iconSize: [25, 41],
              iconAnchor: [12, 41],
              popupAnchor: [1, -34],
              shadowSize: [41, 41]
            });
            }

            var icons = {
            "A": newIcon("green"),
            "B": newIcon("blue"),
            "C": newIcon("gold"),
            "D": newIcon("red"),
            "": newIcon("grey")
            }

            var highlightedLayer = null;
            var layerIndex = {}

            $.getJSON("{{ site.baseurl }}/assets/OHCleveland1939.geojson", function(data) {
            holc_layer = L.geoJson(data, {
              style: function(feature) {
                return {
                  fillColor: holcColor[feature.properties.holc_grade],
                  fillOpacity: 0.3,
                  opacity: 1,
                  weight: 1,
                  color: 'grey'
                }
              },
              onEachFeature: function(feature, layer) {
                layerIndex[layer.feature.properties.holc_id] = layer;
                layer.on('click', function (e) {
                  window.location.href = "{{ site.baseurl }}/sections/" + layer.feature.properties.holc_id + "/";
                });
              }
            }).addTo(map);
            if (typeof section_id === 'undefined') {
              map.fitBounds(holc_layer.getBounds());
            } else {
              map.fitBounds(layerIndex[section_id].getBounds());
              // lock the centre of the map
              map.dragging.disable();
              map.options.scrollWheelZoom = "center";
              // highlight this section
              layerIndex[section_id].setStyle({fillOpacity: 0.5}); 
              // set minimum zoom
              map.options.minZoom = 12;
            }
            });

            {% for worker in site.data.workers %}
            {% if worker.longitude %}
              {% assign holc_id = worker.holc_id %}
              {% assign holc = site.data.holc | where: "id", holc_id | first %}
            L.marker([{{ worker.latitude }}, {{ worker.longitude }}], {icon: icons["{{ worker.holc_id | slice: 0 }}"]})
            .bindPopup(
              "<b>{{ worker.id }}. {{ worker.signature }}</b><br>{{ worker.sex_9 }}, " + 
              "{{ worker.race_10 }}, {{ worker.age_11 | floor }}<br>" + 
              "Occupation: \"{{ worker.occupation_28 }}\"<br>Industry: \"{{ worker.industry_29 }}\"<br>" + 
              "<b>{{ holc_id }}: {{ holc.name }}</b>")
            .addTo(map);
            {% endif %}
            {% endfor %}

        }
    </script>
  {% endif %}

</head>
